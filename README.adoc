= Tulip (The Ultimate Load Injection Program)
:sectnums:
:toc:

== Dependencies

Install Git and JDK21 before building Tulip from source.

=== Linux

Install SDKMAN from bash (https://sdkman.io)
----
$ curl -s "https://get.sdkman.io" | bash
----

----
$ source "$HOME/.sdkman/bin/sdkman-init.sh"
----

----
$ sdk version
----

Install `w3m` (Debian, Ubuntu) to display reports
----
$ sudo apt install w3m
----

=== MacOS

Install SDKMAN from zsh or bash (https://sdkman.io)
----
$ curl -s "https://get.sdkman.io" | bash
----

----
$ source "$HOME/.sdkman/bin/sdkman-init.sh"
----

----
$ sdk version
----

Install `w3m` (MacOS) to display reports
----
$ brew install w3m
----

=== Windows

Open a Windows PowerShell (PS) terminal (version 5.1 or later) and from the PS `C:\>` prompt, run:

.Step 1 - run Set-ExecutionPolicy
----
PS C:\> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
----
.Step 2 - answer 'Y' when prompted to change the execution policy.
----
Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose you to the security risks described in the about_Execution_Policies help topic at https:/go.microsoft.com/fwlink/?LinkID=135170. Do you want to change the execution policy?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): Y
PS C:\>
----

.Step 3 - run Invoke-RestMethod
----
PS C:\> Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
----

.Step 4 - wait for the installation to finish
----
Initializing...
Downloading...
Extracting...
Creating shim...
Adding ~\scoop\shims to your path.
Scoop was installed successfully!
Type 'scoop help' for instructions.
PS C:\>
----

Install Git and Git-Bash

[source,cmd]
----
scoop install git
----

Install MS Java 21 (OpenJDK)
----
scoop bucket add java
----

----
scoop install microsoft21-jdk
----

(Optionally) Install WinGetUI (aka UniGetUI) to apply future updates to the installed applications
----
scoop bucket add extras
----
----
scoop install extras/wingetui
----

== Build from Source

=== Linux

----
git clone https://github.com/wfouche/Tulip.git
cd  Tulip
sdk env install
./go_bench.sh
----

=== MacOS

----
git clone https://github.com/wfouche/Tulip.git
cd  Tulip
sdk env install
go_bench.sh
----

=== Windows

----
git clone https://github.com/wfouche/Tulip.git
cd  Tulip
go_bench.cmd
----

== Example Benchmark Reports

=== HTTP API calls (fast remote system)

[source,text,options=nowrap]
----
Benchmark Report / Micro-benchmarks / 2024-07-19_08:23:26.646

SID          Name           RID Duration  Avg TPS  #F    #N       Avg RT   Stdev   50p RT   90p RT   99p RT   Max RT    Max RTT   Blk   Awt     Mwt
0   Init (u:16 t:2)
                            0   0.048    666.7     0  32        0.180 ms   0.6 ms 0.0 ms   0.3 ms   3.7 ms   3.7 ms   19 08:23:26 0   1.2 ms  33.3 ms
                            -   0:00:00  666.7     0  32        0.180 ms   0.6 ms 0.0 ms   0.3 ms   3.7 ms   3.7 ms   19 08:23:26 0   1.2 ms  33.3 ms
0   Max TPS-a (u:16 t:2)
                            0   30.0     1629445.7 0  48883370  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:24:21 1   0.0 ms  3.8 ms
                            1   30.0     1742934.3 0  52288028  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:25:01 1   0.0 ms  0.9 ms
                            2   30.0     1702689.6 0  51080687  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:25:42 1   0.0 ms  1.0 ms
                            -   0:01:30  1691689.8 0  152252085 0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:25:42 1   0.0 ms  3.8 ms
0   Max TPS-b (u:16 t:2)
                            0   30.0     1000000.0 0  30000000  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:27:05 1   0.0 ms  1.8 ms
                            1   30.0     1000000.0 0  30000000  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.2 ms   19 08:27:20 1   0.0 ms  2.7 ms
                            2   30.0     999999.9  0  29999998  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.1 ms   19 08:28:02 1   0.0 ms  1.5 ms
                            -   0:01:30  1000000.0 0  89999998  0.000 ms   0.0 ms 0.0 ms   0.0 ms   0.0 ms   0.2 ms   19 08:27:20 1   0.0 ms  2.7 ms
0   Fixed TPS-a (u:16 t:2)
                            0   30.0     100.0     0  3001      12.369 ms  8.4 ms 10.2 ms  25.2 ms  28.3 ms  28.3 ms  19 08:29:10 0   7.6 ms  65.5 ms
                            1   30.0     100.0     0  3001      12.069 ms  8.2 ms 10.2 ms  25.2 ms  28.3 ms  28.3 ms  19 08:29:18 0   5.6 ms  69.6 ms
                            2   30.0     100.0     0  3001      12.148 ms  8.3 ms 10.2 ms  25.2 ms  28.3 ms  28.3 ms  19 08:29:59 0   6.3 ms  75.8 ms
                            3   30.0     100.0     0  3001      12.330 ms  8.3 ms 11.3 ms  25.2 ms  28.3 ms  28.4 ms  19 08:30:40 0   6.5 ms  68.1 ms
                            -   0:02:00  100.0     0  12004     12.199 ms  8.3 ms 11.1 ms  25.1 ms  28.2 ms  28.4 ms  19 08:30:40 0   7.6 ms  75.8 ms
0   Fixed TPS-b (u:16 t:2)
                            0   30.0     100.0     0  3000      10.165 ms  0.0 ms 10.2 ms  10.2 ms  10.3 ms  10.3 ms  19 08:31:24 0   0.3 ms  2.1 ms
                            1   30.0     100.0     0  3001      10.164 ms  0.0 ms 10.2 ms  10.2 ms  10.3 ms  10.3 ms  19 08:32:15 0   0.3 ms  2.2 ms
                            2   30.0     100.0     0  3001      10.164 ms  0.0 ms 10.2 ms  10.2 ms  10.2 ms  10.3 ms  19 08:32:32 0   0.3 ms  3.0 ms
                            3   30.0     100.0     0  3000      10.163 ms  0.1 ms 10.2 ms  10.2 ms  10.3 ms  11.6 ms  19 08:32:54 0   0.3 ms  2.3 ms
                            -   0:02:00  100.0     0  12002     10.136 ms  0.0 ms 10.1 ms  10.2 ms  10.2 ms  11.6 ms  19 08:32:54 0   0.3 ms  3.0 ms
0   HTTP-a (u:16 t:2)
                            0   30.0     11136.1   0  334082    0.175 ms   0.0 ms 0.2 ms   0.2 ms   0.3 ms   2.4 ms   19 08:33:52 1   12.3 ms 25.5 ms
                            1   30.0     11038.5   0  331154    0.177 ms   0.0 ms 0.2 ms   0.2 ms   0.3 ms   5.4 ms   19 08:34:21 1   12.3 ms 31.0 ms
                            2   30.0     11002.6   0  330079    0.177 ms   0.0 ms 0.2 ms   0.2 ms   0.3 ms   2.5 ms   19 08:34:51 1   12.6 ms 31.0 ms
                            -   0:01:30  11059.1   0  995315    0.176 ms   0.0 ms 0.2 ms   0.2 ms   0.3 ms   5.4 ms   19 08:34:21 1   12.6 ms 31.0 ms
0   HTTP-b (u:16 t:2)
                            0   30.0     1250.1    0  37502     0.606 ms   0.1 ms 0.6 ms   0.7 ms   0.9 ms   2.9 ms   19 08:36:23 0   0.1 ms  3.3 ms
                            1   30.0     1250.1    0  37502     0.622 ms   0.1 ms 0.6 ms   0.7 ms   0.9 ms   3.0 ms   19 08:36:31 0   0.1 ms  2.0 ms
                            2   30.0     1250.0    0  37501     0.612 ms   0.1 ms 0.6 ms   0.7 ms   0.9 ms   4.7 ms   19 08:36:56 0   0.1 ms  3.8 ms
                            -   0:01:30  1250.1    0  112505    0.611 ms   0.1 ms 0.6 ms   0.7 ms   0.8 ms   4.7 ms   19 08:36:56 0   0.1 ms  3.8 ms
0   Shutdown (u:16 t:2)
                            0   1.608    10.0      0  16        100.192 ms 0.3 ms 100.4 ms 100.9 ms 100.9 ms 100.9 ms 19 08:37:32 0   0.1 ms  0.1 ms
                            -   0:00:01  10.0      0  16        99.968 ms  0.3 ms 99.9 ms  100.4 ms 100.9 ms 100.9 ms 19 08:37:32 0   0.1 ms  0.1 ms
----

=== HTTP API calls (slow remote system)

[source,text,options=nowrap]
----
Benchmark Report / Micro-benchmarks / 2024-07-19_07:15:19.801

SID          Name           RID Duration  Avg TPS  #F    #N      Avg RT    Stdev   50p RT   90p RT   99p RT   Max RT    Max RTT   Blk    Awt       Mwt
0   Init (u:16 t:2)
                            0   0.191    167.5     0  32       0.475 ms   2.2 ms  0.1 ms   0.2 ms   12.5 ms  12.5 ms  19 07:15:19 0   5.3 ms    157.7 ms
                            -   0:00:00  167.5     0  32       0.475 ms   2.2 ms  0.1 ms   0.2 ms   12.6 ms  12.5 ms  19 07:15:19 0   5.3 ms    157.7 ms
0   Max TPS-a (u:16 t:2)
                            0   30.0     1095118.6 0  32853559 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   2.0 ms   19 07:16:21 1   0.0 ms    20.2 ms
                            1   30.0     1060711.2 0  31821335 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   2.7 ms   19 07:16:58 1   0.0 ms    65.3 ms
                            2   30.0     1016098.0 0  30482939 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   6.2 ms   19 07:17:13 1   0.0 ms    131.1 ms
                            -   0:01:30  1057309.3 0  95157833 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   6.2 ms   19 07:17:13 1   0.0 ms    131.1 ms
0   Max TPS-b (u:16 t:2)
                            0   30.0     999957.3  0  29998720 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   0.8 ms   19 07:18:53 1   0.0 ms    27.6 ms
                            1   30.0     996901.8  0  29907054 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   3.1 ms   19 07:19:29 1   0.0 ms    67.1 ms
                            2   30.0     993414.0  0  29802421 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   4.9 ms   19 07:19:32 1   0.0 ms    72.7 ms
                            -   0:01:30  996757.7  0  89708195 0.000 ms   0.0 ms  0.0 ms   0.0 ms   0.0 ms   4.9 ms   19 07:19:32 1   0.0 ms    72.7 ms
0   Fixed TPS-a (u:16 t:2)
                            0   30.0     100.0     0  3001     12.632 ms  8.4 ms  11.1 ms  25.6 ms  29.1 ms  35.1 ms  19 07:20:36 0   7.9 ms    80.4 ms
                            1   30.0     100.0     0  3000     12.688 ms  8.4 ms  11.1 ms  25.3 ms  28.9 ms  45.4 ms  19 07:21:05 0   7.6 ms    72.7 ms
                            2   30.0     100.0     0  3000     12.873 ms  8.3 ms  11.8 ms  25.3 ms  29.1 ms  34.5 ms  19 07:22:03 0   7.8 ms    60.4 ms
                            3   30.0     98.5      0  2955     14.169 ms  10.3 ms 12.2 ms  27.0 ms  48.9 ms  109.0 ms 19 07:22:25 0   13.4 ms   195.6 ms
                            -   0:02:00  99.6      0  11956    13.055 ms  8.9 ms  11.7 ms  25.9 ms  30.7 ms  109.0 ms 19 07:22:25 0   13.4 ms   195.6 ms
0   Fixed TPS-b (u:16 t:2)
                            0   30.0     100.0     0  3000     13.677 ms  4.0 ms  11.8 ms  20.1 ms  25.1 ms  36.0 ms  19 07:23:14 0   6.2 ms    55.8 ms
                            1   30.0     100.0     0  3000     13.306 ms  3.9 ms  11.1 ms  20.1 ms  25.1 ms  36.2 ms  19 07:23:54 0   5.5 ms    51.2 ms
                            2   30.0     100.0     0  3000     12.415 ms  3.2 ms  11.0 ms  16.0 ms  25.1 ms  26.1 ms  19 07:24:10 0   3.1 ms    47.1 ms
                            3   30.0     100.0     0  3000     12.934 ms  3.6 ms  11.0 ms  17.9 ms  25.1 ms  25.6 ms  19 07:25:03 0   5.0 ms    48.1 ms
                            -   0:02:00  100.0     0  12000    13.051 ms  3.7 ms  11.0 ms  19.2 ms  25.0 ms  36.2 ms  19 07:23:54 0   6.2 ms    55.8 ms
0   HTTP-a (u:16 t:2)
                            0   30.0     63.5      0  1906     31.936 ms  3.6 ms  31.7 ms  36.1 ms  42.0 ms  58.2 ms  19 07:26:14 1   2319.3 ms 3375.1 ms
                            1   30.0     63.9      0  1916     31.593 ms  3.6 ms  31.4 ms  35.6 ms  40.7 ms  95.1 ms  19 07:26:35 1   2448.2 ms 3276.8 ms
                            2   30.0     60.6      0  1818     31.871 ms  4.8 ms  31.1 ms  36.9 ms  53.5 ms  85.1 ms  19 07:27:08 1   2533.5 ms 3440.6 ms
                            -   0:01:30  62.7      0  5640     31.725 ms  4.0 ms  31.4 ms  35.9 ms  44.8 ms  95.1 ms  19 07:26:35 1   2533.5 ms 3440.6 ms
0   HTTP-b (u:16 t:2)
                            0   30.0     47.6      0  1428     35.735 ms  16.6 ms 32.6 ms  46.8 ms  76.8 ms  533.8 ms 19 07:28:12 0   47.4 ms   593.9 ms
                            1   30.0     52.0      2  1561     33.745 ms  10.9 ms 31.4 ms  42.2 ms  72.2 ms  236.2 ms 19 07:28:28 0   42.6 ms   278.5 ms
                            2   30.0     46.8      0  1405     37.580 ms  13.6 ms 33.5 ms  51.5 ms  96.8 ms  148.1 ms 19 07:29:12 0   46.4 ms   282.6 ms
                            -   0:01:30  48.8      2  4394     35.533 ms  13.9 ms 32.0 ms  46.6 ms  83.5 ms  533.8 ms 19 07:28:12 0   47.4 ms   593.9 ms
0   Shutdown (u:16 t:2)
                            0   1.805    8.9       0  16       112.528 ms 11.2 ms 109.6 ms 121.9 ms 151.8 ms 151.8 ms 19 07:29:30 0   0.0 ms    0.1 ms
                            -   0:00:01  8.9       0  16       112.290 ms 11.2 ms 109.1 ms 121.4 ms 151.7 ms 151.8 ms 19 07:29:30 0   0.0 ms    0.1 ms
----

== Example Benchmark Configuration

=== Default Test Configuration

[source,json]
----
{
    "description": "Micro-benchmarks",
    "json_filename": "benchmark_results.json",
    "user_class": "user.http.HttpUser",
    "user_params": {
        "url": "https://jsonplaceholder.typicode.com",
        "urlx": "http://localhost:7070"
    },
    "user_actions": {
        "0": "start",
        "1": "DELAY-6ms",
        "2": "DELAY-14ms",
        "3": "HTTP-posts",
        "4": "HTTP-comments",
        "5": "HTTP-albums",
        "6": "HTTP-photos",
        "7": "HTTP-todos",
        "8": "login",
        "9": "noop",
        "10": "DELAY-10ms",
        "99": "stop"
    },
    "contexts": [
        {
            "name": "Scenario-1",
            "enabled": true,
            "num_users": 16,
            "num_threads": 2
        },
        {
            "name": "Scenario-2",
            "enabled": false,
            "num_users": 32,
            "num_threads": 4
        }
    ],
    "benchmarks": [
        {
            "name": "Init",
            "enabled": true,
            "time": {
                "prewarmup_duration": 0,
                "warmup_duration": 0,
                "benchmark_duration": 0,
                "benchmark_duration_repeat_count": 1
            },
            "throughput_rate": 0.0,
            "work_in_progress": 1,
            "actions": [
                {
                    "id": 0
                },
                {
                    "id": 8
                }
            ]
        },
        {
            "name": "Max TPS-a",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 30,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 3
            },
            "throughput_rate": 0.0,
            "work_in_progress": -1,
            "actions": [
                {
                    "id": 9
                }
            ]
        },
        {
            "name": "Max TPS-b",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 30,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 3
            },
            "throughput_rate": 1000000.0,
            "work_in_progress": -1,
            "actions": [
                {
                    "id": 9
                }
            ]
        },
        {
            "name": "Fixed TPS-a",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 15,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 4
            },
            "throughput_rate": 100.0,
            "work_in_progress": 0,
            "actions": [
                {
                    "id": 1,
                    "weight": 25
                },
                {
                    "id": 2,
                    "weight": 75
                }
            ]
        },
        {
            "name": "Fixed TPS-b",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 15,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 4
            },
            "throughput_rate": 100.0,
            "work_in_progress": 0,
            "actions": [
                {
                    "id": 10
                }
            ]
        },
        {
            "name": "HTTP-a",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 15,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 3
            },
            "throughput_rate": 0.0,
            "work_in_progress": -1,
            "actions": [
                {
                    "id": 3
                },
                {
                    "id": 4
                },
                {
                    "id": 5
                },
                {
                    "id": 6
                },
                {
                    "id": 7
                }
            ]
        },
        {
            "name": "HTTP-b",
            "enabled": true,
            "time": {
                "prewarmup_duration": 15,
                "warmup_duration": 15,
                "benchmark_duration": 30,
                "benchmark_duration_repeat_count": 3
            },
            "throughput_rate": 1250.0,
            "work_in_progress": 0,
            "actions": [
                {
                    "id": 3
                },
                {
                    "id": 4
                },
                {
                    "id": 5
                },
                {
                    "id": 6
                },
                {
                    "id": 7
                }
            ]
        },
        {
            "name": "Shutdown",
            "enabled": true,
            "time": {
                "prewarmup_duration": 0,
                "warmup_duration": 0,
                "benchmark_duration": 0,
                "benchmark_duration_repeat_count": 1
            },
            "throughput_rate": 0.0,
            "work_in_progress": 1,
            "actions": [
                {
                    "id": 99
                }
            ]
        }
    ]
}
----

== Appendix

=== Coordinated Omission

Tulip compensates for back-pressure from the system under test and adjusts the measured service times accordingly:

* https://redhatperf.github.io/post/coordinated-omission/

=== Kotlin Books

* https://www.manning.com/books/kotlin-in-action[Kotlin in Action, 1st Edition]
* https://www.manning.com/books/kotlin-in-action-second-edition[Kotlin in Action, 2nd Edition]
* https://typealias.com/start/[Kotlin: An Illustrated Guide]

=== Performance Engineering

* "Stop Rate Limiting! Capacity Management Done Right" by Jon Moore
** https://www.youtube.com/watch?v=m64SWl9bfvk
